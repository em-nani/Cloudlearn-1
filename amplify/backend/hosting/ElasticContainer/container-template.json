{
    "Parameters": {
        "env": {
            "Type": "String"
        },
        "domain": {
            "Type": "String",
            "Default": ""
        },
        "restrictAccess": {
            "Type": "String",
            "Default": "false",
            "AllowedValues": [
                "true",
                "false"
            ]
        },
        "ParamZipPath": {
            "Type": "String",
            "Default": "site.zip"
        },
        "NetworkStackClusterName": {
            "Type": "String"
        },
        "NetworkStackVpcId": {
            "Type": "String"
        },
        "NetworkStackVpcCidrBlock": {
            "Type": "String"
        },
        "NetworkStackSubnetIds": {
            "Type": "CommaDelimitedList"
        },
        "NetworkStackVpcLinkId": {
            "Type": "String"
        },
        "NetworkStackCloudMapNamespaceId": {
            "Type": "String"
        },
        "rootStackName": {
            "Type": "String"
        },
        "deploymentBucketName": {
            "Type": "String"
        },
        "awaiterS3Key": {
            "Type": "String",
            "Default": "custom-resource-pipeline-awaiter.zip"
        }
    },
    "Conditions": {
        "isAuthCondition": {
            "Fn::And": [
                {
                    "Fn::Equals": [
                        false,
                        true
                    ]
                },
                {
                    "Fn::Not": [
                        {
                            "Fn::Equals": [
                                "",
                                ""
                            ]
                        }
                    ]
                },
                {
                    "Fn::Not": [
                        {
                            "Fn::Equals": [
                                "",
                                ""
                            ]
                        }
                    ]
                }
            ]
        }
    },
    "Resources": {
        "TaskDefinitionTaskRoleFD40A61D": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ecs-tasks.amazonaws.com"
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                }
            }
        },
        "TaskDefinition": {
            "Type": "AWS::ECS::TaskDefinition",
            "Properties": {
                "ContainerDefinitions": [
                    {
                        "Command": [],
                        "EntryPoint": [],
                        "Environment": [],
                        "Essential": true,
                        "Image": {
                            "Fn::Join": [
                                "",
                                [
                                    {
                                        "Fn::Select": [
                                            4,
                                            {
                                                "Fn::Split": [
                                                    ":",
                                                    {
                                                        "Fn::GetAtt": [
                                                            "apiRepository",
                                                            "Arn"
                                                        ]
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    ".dkr.ecr.",
                                    {
                                        "Fn::Select": [
                                            3,
                                            {
                                                "Fn::Split": [
                                                    ":",
                                                    {
                                                        "Fn::GetAtt": [
                                                            "apiRepository",
                                                            "Arn"
                                                        ]
                                                    }
                                                ]
                                            }
                                        ]
                                    },
                                    ".",
                                    {
                                        "Ref": "AWS::URLSuffix"
                                    },
                                    "/",
                                    {
                                        "Ref": "apiRepository"
                                    },
                                    ":latest"
                                ]
                            ]
                        },
                        "LogConfiguration": {
                            "LogDriver": "awslogs",
                            "Options": {
                                "awslogs-group": {
                                    "Ref": "apiContainerLogGroupA9A8D168"
                                },
                                "awslogs-stream-prefix": "ecs",
                                "awslogs-region": {
                                    "Ref": "AWS::Region"
                                }
                            }
                        },
                        "Name": "api",
                        "PortMappings": [
                            {
                                "ContainerPort": 8080,
                                "Protocol": "tcp"
                            }
                        ],
                        "Secrets": []
                    }
                ],
                "Cpu": "512",
                "ExecutionRoleArn": {
                    "Fn::GetAtt": [
                        "TaskDefinitionExecutionRole8D61C2FB",
                        "Arn"
                    ]
                },
                "Family": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "rootStackName"
                            },
                            "-site"
                        ]
                    ]
                },
                "Memory": "1024",
                "NetworkMode": "awsvpc",
                "RequiresCompatibilities": [
                    "FARGATE"
                ],
                "TaskRoleArn": {
                    "Fn::GetAtt": [
                        "TaskDefinitionTaskRoleFD40A61D",
                        "Arn"
                    ]
                }
            }
        },
        "TaskDefinitionExecutionRole8D61C2FB": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "ecs-tasks.amazonaws.com"
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                }
            }
        },
        "TaskDefinitionExecutionRoleDefaultPolicy1F3406F5": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "ecr:BatchCheckLayerAvailability",
                                "ecr:GetDownloadUrlForLayer",
                                "ecr:BatchGetImage"
                            ],
                            "Effect": "Allow",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "apiRepository",
                                    "Arn"
                                ]
                            }
                        },
                        {
                            "Action": "ecr:GetAuthorizationToken",
                            "Effect": "Allow",
                            "Resource": "*"
                        },
                        {
                            "Action": [
                                "logs:CreateLogStream",
                                "logs:PutLogEvents"
                            ],
                            "Effect": "Allow",
                            "Resource": {
                                "Fn::Join": [
                                    "",
                                    [
                                        "arn:",
                                        {
                                            "Ref": "AWS::Partition"
                                        },
                                        ":logs:",
                                        {
                                            "Ref": "AWS::Region"
                                        },
                                        ":",
                                        {
                                            "Ref": "AWS::AccountId"
                                        },
                                        ":log-group:",
                                        {
                                            "Ref": "apiContainerLogGroupA9A8D168"
                                        },
                                        ":*"
                                    ]
                                ]
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "PolicyName": "TaskDefinitionExecutionRoleDefaultPolicy1F3406F5",
                "Roles": [
                    {
                        "Ref": "TaskDefinitionExecutionRole8D61C2FB"
                    }
                ]
            }
        },
        "apiContainerLogGroupA9A8D168": {
            "Type": "AWS::Logs::LogGroup",
            "Properties": {
                "LogGroupName": {
                    "Fn::Join": [
                        "",
                        [
                            "/ecs/",
                            {
                                "Ref": "rootStackName"
                            },
                            "-site-api"
                        ]
                    ]
                },
                "RetentionInDays": 30
            },
            "UpdateReplacePolicy": "Delete",
            "DeletionPolicy": "Delete"
        },
        "apiRepository": {
            "Type": "AWS::ECR::Repository",
            "Properties": {
                "LifecyclePolicy": {
                    "LifecyclePolicyText": "{\"rules\":[{\"rulePriority\":10,\"selection\":{\"tagStatus\":\"tagged\",\"tagPrefixList\":[\"latest\"],\"countType\":\"imageCountMoreThan\",\"countNumber\":1},\"action\":{\"type\":\"expire\"}},{\"rulePriority\":100,\"selection\":{\"tagStatus\":\"any\",\"countType\":\"sinceImagePushed\",\"countNumber\":7,\"countUnit\":\"days\"},\"action\":{\"type\":\"expire\"}}]}"
                },
                "RepositoryName": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "rootStackName"
                            },
                            "-hosting-site-api"
                        ]
                    ]
                }
            },
            "UpdateReplacePolicy": "Retain",
            "DeletionPolicy": "Retain"
        },
        "ServiceSG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Service SecurityGroup",
                "SecurityGroupEgress": [
                    {
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow all outbound traffic by default",
                        "IpProtocol": "-1"
                    }
                ],
                "SecurityGroupIngress": [
                    {
                        "CidrIp": {
                            "Ref": "NetworkStackVpcCidrBlock"
                        },
                        "FromPort": 8080,
                        "IpProtocol": "tcp",
                        "ToPort": 8080
                    },
                    {
                        "FromPort": 8080,
                        "IpProtocol": "tcp",
                        "SourceSecurityGroupId": {
                            "Fn::GetAtt": [
                                "AlbSecurityGroup",
                                "GroupId"
                            ]
                        },
                        "ToPort": 8080
                    }
                ],
                "VpcId": {
                    "Ref": "NetworkStackVpcId"
                }
            }
        },
        "Service": {
            "Type": "AWS::ECS::Service",
            "Properties": {
                "Cluster": {
                    "Ref": "NetworkStackClusterName"
                },
                "DesiredCount": 0,
                "LaunchType": "FARGATE",
                "LoadBalancers": [
                    {
                        "ContainerName": "api",
                        "ContainerPort": 8080,
                        "TargetGroupArn": {
                            "Ref": "TargetGroup"
                        }
                    }
                ],
                "NetworkConfiguration": {
                    "AwsvpcConfiguration": {
                        "AssignPublicIp": "ENABLED",
                        "SecurityGroups": [
                            {
                                "Fn::GetAtt": [
                                    "ServiceSG",
                                    "GroupId"
                                ]
                            }
                        ],
                        "Subnets": {
                            "Ref": "NetworkStackSubnetIds"
                        }
                    }
                },
                "ServiceName": "site-service-api-8080",
                "TaskDefinition": {
                    "Ref": "TaskDefinition"
                }
            },
            "DependsOn": [
                "AlbListener",
                "AlbListenerRule"
            ]
        },
        "ApiPipelineCodeBuildProjectRoleCFB98631": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "codebuild.amazonaws.com"
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                }
            }
        },
        "ApiPipelineCodeBuildProjectRoleDefaultPolicyAF1730E7": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "logs:CreateLogGroup",
                                "logs:CreateLogStream",
                                "logs:PutLogEvents"
                            ],
                            "Effect": "Allow",
                            "Resource": [
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:",
                                            {
                                                "Ref": "AWS::Partition"
                                            },
                                            ":logs:",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            ":",
                                            {
                                                "Ref": "AWS::AccountId"
                                            },
                                            ":log-group:/aws/codebuild/",
                                            {
                                                "Ref": "ApiPipelineCodeBuildProject117EE1BE"
                                            }
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:",
                                            {
                                                "Ref": "AWS::Partition"
                                            },
                                            ":logs:",
                                            {
                                                "Ref": "AWS::Region"
                                            },
                                            ":",
                                            {
                                                "Ref": "AWS::AccountId"
                                            },
                                            ":log-group:/aws/codebuild/",
                                            {
                                                "Ref": "ApiPipelineCodeBuildProject117EE1BE"
                                            },
                                            ":*"
                                        ]
                                    ]
                                }
                            ]
                        },
                        {
                            "Action": [
                                "codebuild:CreateReportGroup",
                                "codebuild:CreateReport",
                                "codebuild:UpdateReport",
                                "codebuild:BatchPutTestCases",
                                "codebuild:BatchPutCodeCoverages"
                            ],
                            "Effect": "Allow",
                            "Resource": {
                                "Fn::Join": [
                                    "",
                                    [
                                        "arn:",
                                        {
                                            "Ref": "AWS::Partition"
                                        },
                                        ":codebuild:",
                                        {
                                            "Ref": "AWS::Region"
                                        },
                                        ":",
                                        {
                                            "Ref": "AWS::AccountId"
                                        },
                                        ":report-group/",
                                        {
                                            "Ref": "ApiPipelineCodeBuildProject117EE1BE"
                                        },
                                        "-*"
                                    ]
                                ]
                            }
                        },
                        {
                            "Action": [
                                "ecr:GetAuthorizationToken",
                                "ecr:BatchGetImage",
                                "ecr:BatchGetDownloadUrlForLayer",
                                "ecr:InitiateLayerUpload",
                                "ecr:BatchCheckLayerAvailability",
                                "ecr:UploadLayerPart",
                                "ecr:CompleteLayerUpload",
                                "ecr:PutImage"
                            ],
                            "Effect": "Allow",
                            "Resource": "*"
                        },
                        {
                            "Action": [
                                "s3:GetObject*",
                                "s3:GetBucket*",
                                "s3:List*",
                                "s3:DeleteObject*",
                                "s3:PutObject*",
                                "s3:Abort*"
                            ],
                            "Effect": "Allow",
                            "Resource": [
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:",
                                            {
                                                "Ref": "AWS::Partition"
                                            },
                                            ":s3:::",
                                            {
                                                "Ref": "deploymentBucketName"
                                            }
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:",
                                            {
                                                "Ref": "AWS::Partition"
                                            },
                                            ":s3:::",
                                            {
                                                "Ref": "deploymentBucketName"
                                            },
                                            "/*"
                                        ]
                                    ]
                                }
                            ]
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "PolicyName": "ApiPipelineCodeBuildProjectRoleDefaultPolicyAF1730E7",
                "Roles": [
                    {
                        "Ref": "ApiPipelineCodeBuildProjectRoleCFB98631"
                    }
                ]
            }
        },
        "ApiPipelineCodeBuildProject117EE1BE": {
            "Type": "AWS::CodeBuild::Project",
            "Properties": {
                "Artifacts": {
                    "Type": "CODEPIPELINE"
                },
                "Environment": {
                    "ComputeType": "BUILD_GENERAL1_SMALL",
                    "Image": "aws/codebuild/standard:4.0",
                    "ImagePullCredentialsType": "CODEBUILD",
                    "PrivilegedMode": true,
                    "Type": "LINUX_CONTAINER"
                },
                "ServiceRole": {
                    "Fn::GetAtt": [
                        "ApiPipelineCodeBuildProjectRoleCFB98631",
                        "Arn"
                    ]
                },
                "Source": {
                    "Type": "CODEPIPELINE"
                },
                "EncryptionKey": "alias/aws/s3"
            }
        },
        "PreDeployLambdaServiceRole87EE44C9": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "lambda.amazonaws.com"
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "ManagedPolicyArns": [
                    {
                        "Fn::Join": [
                            "",
                            [
                                "arn:",
                                {
                                    "Ref": "AWS::Partition"
                                },
                                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
                            ]
                        ]
                    }
                ]
            }
        },
        "PreDeployLambdaServiceRoleDefaultPolicyD9F42A87": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Action": "ecs:UpdateService",
                            "Effect": "Allow",
                            "Resource": {
                                "Ref": "Service"
                            }
                        },
                        {
                            "Action": [
                                "codepipeline:PutJobSuccessResult",
                                "codepipeline:PutJobFailureResult"
                            ],
                            "Effect": "Allow",
                            "Resource": "*"
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "PolicyName": "PreDeployLambdaServiceRoleDefaultPolicyD9F42A87",
                "Roles": [
                    {
                        "Ref": "PreDeployLambdaServiceRole87EE44C9"
                    }
                ]
            }
        },
        "PreDeployLambdaF7CAA99F": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "ZipFile": "const AWS = require('aws-sdk');\n\nconst codepipeline = new AWS.CodePipeline();\nconst ecs = new AWS.ECS();\n\nconst { DESIRED_COUNT: desiredCountStr, CLUSTER_NAME: cluster, SERVICE_NAME: service } = process.env;\n\nconst desiredCount = parseInt(desiredCountStr, 10);\n\nexports.handler = async function({ 'CodePipeline.job': { id: jobId } }) {\n  await ecs\n    .updateService({\n      service,\n      cluster,\n      desiredCount,\n    })\n    .promise();\n\n  return await codepipeline.putJobSuccessResult({ jobId }).promise();\n};\n"
                },
                "Role": {
                    "Fn::GetAtt": [
                        "PreDeployLambdaServiceRole87EE44C9",
                        "Arn"
                    ]
                },
                "Environment": {
                    "Variables": {
                        "DESIRED_COUNT": "1",
                        "CLUSTER_NAME": {
                            "Ref": "NetworkStackClusterName"
                        },
                        "SERVICE_NAME": "site-service-api-8080"
                    }
                },
                "Handler": "index.handler",
                "Runtime": "nodejs12.x",
                "Timeout": 15
            },
            "DependsOn": [
                "PreDeployLambdaServiceRoleDefaultPolicyD9F42A87",
                "PreDeployLambdaServiceRole87EE44C9"
            ]
        },
        "ApiPipelinePipelineRole8C805448": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "Service": "codepipeline.amazonaws.com"
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                }
            },
            "DependsOn": [
                "Service"
            ]
        },
        "ApiPipelinePipelineRoleDefaultPolicyB3AD67CF": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "s3:GetObject*",
                                "s3:GetBucket*",
                                "s3:List*",
                                "s3:DeleteObject*",
                                "s3:PutObject*",
                                "s3:Abort*"
                            ],
                            "Effect": "Allow",
                            "Resource": [
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:",
                                            {
                                                "Ref": "AWS::Partition"
                                            },
                                            ":s3:::",
                                            {
                                                "Ref": "deploymentBucketName"
                                            }
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:",
                                            {
                                                "Ref": "AWS::Partition"
                                            },
                                            ":s3:::",
                                            {
                                                "Ref": "deploymentBucketName"
                                            },
                                            "/*"
                                        ]
                                    ]
                                }
                            ]
                        },
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "ApiPipelinePipelineSourceCodePipelineActionRole59037A7A",
                                    "Arn"
                                ]
                            }
                        },
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "ApiPipelinePipelineBuildCodePipelineActionRole04E6F13B",
                                    "Arn"
                                ]
                            }
                        },
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "ApiPipelinePipelinePredeployCodePipelineActionRole387C06F4",
                                    "Arn"
                                ]
                            }
                        },
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "ApiPipelinePipelineDeployCodePipelineActionRoleEA4B81BD",
                                    "Arn"
                                ]
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "PolicyName": "ApiPipelinePipelineRoleDefaultPolicyB3AD67CF",
                "Roles": [
                    {
                        "Ref": "ApiPipelinePipelineRole8C805448"
                    }
                ]
            },
            "DependsOn": [
                "Service"
            ]
        },
        "ApiPipelinePipeline68596884": {
            "Type": "AWS::CodePipeline::Pipeline",
            "Properties": {
                "RoleArn": {
                    "Fn::GetAtt": [
                        "ApiPipelinePipelineRole8C805448",
                        "Arn"
                    ]
                },
                "Stages": [
                    {
                        "Actions": [
                            {
                                "ActionTypeId": {
                                    "Category": "Source",
                                    "Owner": "AWS",
                                    "Provider": "S3",
                                    "Version": "1"
                                },
                                "Configuration": {
                                    "S3Bucket": {
                                        "Ref": "deploymentBucketName"
                                    },
                                    "S3ObjectKey": {
                                        "Ref": "ParamZipPath"
                                    }
                                },
                                "Name": "Source",
                                "OutputArtifacts": [
                                    {
                                        "Name": "SourceArtifact"
                                    }
                                ],
                                "RoleArn": {
                                    "Fn::GetAtt": [
                                        "ApiPipelinePipelineSourceCodePipelineActionRole59037A7A",
                                        "Arn"
                                    ]
                                },
                                "RunOrder": 1
                            }
                        ],
                        "Name": "Source"
                    },
                    {
                        "Actions": [
                            {
                                "ActionTypeId": {
                                    "Category": "Build",
                                    "Owner": "AWS",
                                    "Provider": "CodeBuild",
                                    "Version": "1"
                                },
                                "Configuration": {
                                    "ProjectName": {
                                        "Ref": "ApiPipelineCodeBuildProject117EE1BE"
                                    },
                                    "EnvironmentVariables": {
                                        "Fn::Join": [
                                            "",
                                            [
                                                "[{\"name\":\"AWS_ACCOUNT_ID\",\"type\":\"PLAINTEXT\",\"value\":\"",
                                                {
                                                    "Ref": "AWS::AccountId"
                                                },
                                                "\"},{\"name\":\"api_REPOSITORY_URI\",\"type\":\"PLAINTEXT\",\"value\":\"",
                                                {
                                                    "Fn::Select": [
                                                        4,
                                                        {
                                                            "Fn::Split": [
                                                                ":",
                                                                {
                                                                    "Fn::GetAtt": [
                                                                        "apiRepository",
                                                                        "Arn"
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                },
                                                ".dkr.ecr.",
                                                {
                                                    "Fn::Select": [
                                                        3,
                                                        {
                                                            "Fn::Split": [
                                                                ":",
                                                                {
                                                                    "Fn::GetAtt": [
                                                                        "apiRepository",
                                                                        "Arn"
                                                                    ]
                                                                }
                                                            ]
                                                        }
                                                    ]
                                                },
                                                ".",
                                                {
                                                    "Ref": "AWS::URLSuffix"
                                                },
                                                "/",
                                                {
                                                    "Ref": "apiRepository"
                                                },
                                                "\"}]"
                                            ]
                                        ]
                                    }
                                },
                                "InputArtifacts": [
                                    {
                                        "Name": "SourceArtifact"
                                    }
                                ],
                                "Name": "Build",
                                "OutputArtifacts": [
                                    {
                                        "Name": "BuildArtifact"
                                    }
                                ],
                                "RoleArn": {
                                    "Fn::GetAtt": [
                                        "ApiPipelinePipelineBuildCodePipelineActionRole04E6F13B",
                                        "Arn"
                                    ]
                                },
                                "RunOrder": 1
                            }
                        ],
                        "Name": "Build"
                    },
                    {
                        "Actions": [
                            {
                                "ActionTypeId": {
                                    "Category": "Invoke",
                                    "Owner": "AWS",
                                    "Provider": "Lambda",
                                    "Version": "1"
                                },
                                "Configuration": {
                                    "FunctionName": {
                                        "Ref": "PreDeployLambdaF7CAA99F"
                                    }
                                },
                                "Name": "Predeploy",
                                "RoleArn": {
                                    "Fn::GetAtt": [
                                        "ApiPipelinePipelinePredeployCodePipelineActionRole387C06F4",
                                        "Arn"
                                    ]
                                },
                                "RunOrder": 1
                            }
                        ],
                        "Name": "Predeploy"
                    },
                    {
                        "Actions": [
                            {
                                "ActionTypeId": {
                                    "Category": "Deploy",
                                    "Owner": "AWS",
                                    "Provider": "ECS",
                                    "Version": "1"
                                },
                                "Configuration": {
                                    "ClusterName": {
                                        "Ref": "NetworkStackClusterName"
                                    },
                                    "ServiceName": "site-service-api-8080"
                                },
                                "InputArtifacts": [
                                    {
                                        "Name": "BuildArtifact"
                                    }
                                ],
                                "Name": "Deploy",
                                "RoleArn": {
                                    "Fn::GetAtt": [
                                        "ApiPipelinePipelineDeployCodePipelineActionRoleEA4B81BD",
                                        "Arn"
                                    ]
                                },
                                "RunOrder": 1
                            }
                        ],
                        "Name": "Deploy"
                    }
                ],
                "ArtifactStore": {
                    "Location": {
                        "Ref": "deploymentBucketName"
                    },
                    "Type": "S3"
                },
                "Name": {
                    "Fn::Join": [
                        "",
                        [
                            {
                                "Ref": "rootStackName"
                            },
                            "-site-service-api-8080"
                        ]
                    ]
                }
            },
            "DependsOn": [
                "ApiPipelinePipelineRoleDefaultPolicyB3AD67CF",
                "ApiPipelinePipelineRole8C805448",
                "Service"
            ]
        },
        "ApiPipelinePipelineSourceCodePipelineActionRole59037A7A": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:",
                                            {
                                                "Ref": "AWS::Partition"
                                            },
                                            ":iam::",
                                            {
                                                "Ref": "AWS::AccountId"
                                            },
                                            ":root"
                                        ]
                                    ]
                                }
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                }
            },
            "DependsOn": [
                "Service"
            ]
        },
        "ApiPipelinePipelineSourceCodePipelineActionRoleDefaultPolicyE5B48B86": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "s3:GetObject*",
                                "s3:GetBucket*",
                                "s3:List*"
                            ],
                            "Effect": "Allow",
                            "Resource": [
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:",
                                            {
                                                "Ref": "AWS::Partition"
                                            },
                                            ":s3:::",
                                            {
                                                "Ref": "deploymentBucketName"
                                            }
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:",
                                            {
                                                "Ref": "AWS::Partition"
                                            },
                                            ":s3:::",
                                            {
                                                "Ref": "deploymentBucketName"
                                            },
                                            "/",
                                            {
                                                "Ref": "ParamZipPath"
                                            }
                                        ]
                                    ]
                                }
                            ]
                        },
                        {
                            "Action": [
                                "s3:DeleteObject*",
                                "s3:PutObject*",
                                "s3:Abort*"
                            ],
                            "Effect": "Allow",
                            "Resource": [
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:",
                                            {
                                                "Ref": "AWS::Partition"
                                            },
                                            ":s3:::",
                                            {
                                                "Ref": "deploymentBucketName"
                                            }
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:",
                                            {
                                                "Ref": "AWS::Partition"
                                            },
                                            ":s3:::",
                                            {
                                                "Ref": "deploymentBucketName"
                                            },
                                            "/*"
                                        ]
                                    ]
                                }
                            ]
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "PolicyName": "ApiPipelinePipelineSourceCodePipelineActionRoleDefaultPolicyE5B48B86",
                "Roles": [
                    {
                        "Ref": "ApiPipelinePipelineSourceCodePipelineActionRole59037A7A"
                    }
                ]
            },
            "DependsOn": [
                "Service"
            ]
        },
        "ApiPipelinePipelineBuildCodePipelineActionRole04E6F13B": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:",
                                            {
                                                "Ref": "AWS::Partition"
                                            },
                                            ":iam::",
                                            {
                                                "Ref": "AWS::AccountId"
                                            },
                                            ":root"
                                        ]
                                    ]
                                }
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                }
            },
            "DependsOn": [
                "Service"
            ]
        },
        "ApiPipelinePipelineBuildCodePipelineActionRoleDefaultPolicy821C7A3A": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "codebuild:BatchGetBuilds",
                                "codebuild:StartBuild",
                                "codebuild:StopBuild"
                            ],
                            "Effect": "Allow",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "ApiPipelineCodeBuildProject117EE1BE",
                                    "Arn"
                                ]
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "PolicyName": "ApiPipelinePipelineBuildCodePipelineActionRoleDefaultPolicy821C7A3A",
                "Roles": [
                    {
                        "Ref": "ApiPipelinePipelineBuildCodePipelineActionRole04E6F13B"
                    }
                ]
            },
            "DependsOn": [
                "Service"
            ]
        },
        "ApiPipelinePipelinePredeployCodePipelineActionRole387C06F4": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:",
                                            {
                                                "Ref": "AWS::Partition"
                                            },
                                            ":iam::",
                                            {
                                                "Ref": "AWS::AccountId"
                                            },
                                            ":root"
                                        ]
                                    ]
                                }
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                }
            },
            "DependsOn": [
                "Service"
            ]
        },
        "ApiPipelinePipelinePredeployCodePipelineActionRoleDefaultPolicy715F96BC": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Action": "lambda:ListFunctions",
                            "Effect": "Allow",
                            "Resource": "*"
                        },
                        {
                            "Action": "lambda:InvokeFunction",
                            "Effect": "Allow",
                            "Resource": {
                                "Fn::GetAtt": [
                                    "PreDeployLambdaF7CAA99F",
                                    "Arn"
                                ]
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "PolicyName": "ApiPipelinePipelinePredeployCodePipelineActionRoleDefaultPolicy715F96BC",
                "Roles": [
                    {
                        "Ref": "ApiPipelinePipelinePredeployCodePipelineActionRole387C06F4"
                    }
                ]
            },
            "DependsOn": [
                "Service"
            ]
        },
        "ApiPipelinePipelineDeployCodePipelineActionRoleEA4B81BD": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Statement": [
                        {
                            "Action": "sts:AssumeRole",
                            "Effect": "Allow",
                            "Principal": {
                                "AWS": {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:",
                                            {
                                                "Ref": "AWS::Partition"
                                            },
                                            ":iam::",
                                            {
                                                "Ref": "AWS::AccountId"
                                            },
                                            ":root"
                                        ]
                                    ]
                                }
                            }
                        }
                    ],
                    "Version": "2012-10-17"
                }
            },
            "DependsOn": [
                "Service"
            ]
        },
        "ApiPipelinePipelineDeployCodePipelineActionRoleDefaultPolicyB03FE2A4": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Action": [
                                "ecs:DescribeServices",
                                "ecs:DescribeTaskDefinition",
                                "ecs:DescribeTasks",
                                "ecs:ListTasks",
                                "ecs:RegisterTaskDefinition",
                                "ecs:UpdateService"
                            ],
                            "Effect": "Allow",
                            "Resource": "*"
                        },
                        {
                            "Action": "iam:PassRole",
                            "Condition": {
                                "StringEqualsIfExists": {
                                    "iam:PassedToService": [
                                        "ec2.amazonaws.com",
                                        "ecs-tasks.amazonaws.com"
                                    ]
                                }
                            },
                            "Effect": "Allow",
                            "Resource": "*"
                        },
                        {
                            "Action": [
                                "s3:GetObject*",
                                "s3:GetBucket*",
                                "s3:List*"
                            ],
                            "Effect": "Allow",
                            "Resource": [
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:",
                                            {
                                                "Ref": "AWS::Partition"
                                            },
                                            ":s3:::",
                                            {
                                                "Ref": "deploymentBucketName"
                                            }
                                        ]
                                    ]
                                },
                                {
                                    "Fn::Join": [
                                        "",
                                        [
                                            "arn:",
                                            {
                                                "Ref": "AWS::Partition"
                                            },
                                            ":s3:::",
                                            {
                                                "Ref": "deploymentBucketName"
                                            },
                                            "/*"
                                        ]
                                    ]
                                }
                            ]
                        }
                    ],
                    "Version": "2012-10-17"
                },
                "PolicyName": "ApiPipelinePipelineDeployCodePipelineActionRoleDefaultPolicyB03FE2A4",
                "Roles": [
                    {
                        "Ref": "ApiPipelinePipelineDeployCodePipelineActionRoleEA4B81BD"
                    }
                ]
            },
            "DependsOn": [
                "Service"
            ]
        },
        "Certificate": {
            "Type": "AWS::CertificateManager::Certificate",
            "Properties": {
                "DomainName": "*.tfs.services",
                "DomainValidationOptions": [
                    {
                        "DomainName": "*.tfs.services",
                        "HostedZoneId": "Z07716653GDXJUDL4P879"
                    }
                ],
                "ValidationMethod": "DNS"
            }
        },
        "TargetGroup": {
            "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
            "Properties": {
                "HealthCheckIntervalSeconds": 90,
                "HealthCheckPath": "/",
                "HealthCheckTimeoutSeconds": 60,
                "HealthyThresholdCount": 2,
                "Port": 8080,
                "Protocol": "HTTP",
                "TargetType": "ip",
                "UnhealthyThresholdCount": 2,
                "VpcId": {
                    "Ref": "NetworkStackVpcId"
                }
            }
        },
        "AlbSecurityGroup": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "ALB Security Group",
                "SecurityGroupEgress": [
                    {
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow all outbound traffic by default",
                        "IpProtocol": "-1"
                    }
                ],
                "SecurityGroupIngress": [
                    {
                        "CidrIp": "0.0.0.0/0",
                        "Description": "Allow from anyone on port 443",
                        "FromPort": 443,
                        "IpProtocol": "tcp",
                        "ToPort": 443
                    }
                ],
                "VpcId": {
                    "Ref": "NetworkStackVpcId"
                }
            }
        },
        "LoadBalancer": {
            "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
            "Properties": {
                "LoadBalancerAttributes": [
                    {
                        "Key": "deletion_protection.enabled",
                        "Value": "false"
                    }
                ],
                "Scheme": "internet-facing",
                "SecurityGroups": [
                    {
                        "Fn::GetAtt": [
                            "AlbSecurityGroup",
                            "GroupId"
                        ]
                    }
                ],
                "Subnets": {
                    "Ref": "NetworkStackSubnetIds"
                },
                "Type": "application"
            }
        },
        "AlbListener": {
            "Type": "AWS::ElasticLoadBalancingV2::Listener",
            "Properties": {
                "DefaultActions": [
                    {
                        "FixedResponseConfig": {
                            "StatusCode": "403"
                        },
                        "Type": "fixed-response"
                    }
                ],
                "LoadBalancerArn": {
                    "Ref": "LoadBalancer"
                },
                "Certificates": [
                    {
                        "CertificateArn": {
                            "Ref": "Certificate"
                        }
                    }
                ],
                "Port": 443,
                "Protocol": "HTTPS"
            }
        },
        "AlbListenerRule": {
            "Type": "AWS::ElasticLoadBalancingV2::ListenerRule",
            "Properties": {
                "Actions": [
                    {
                        "Order": 1,
                        "TargetGroupArn": {
                            "Ref": "TargetGroup"
                        },
                        "Type": "forward"
                    }
                ],
                "Conditions": [
                    {
                        "Field": "host-header",
                        "HostHeaderConfig": {
                            "Values": [
                                "containers.tfs.services"
                            ]
                        }
                    },
                    {
                        "Field": "http-header",
                        "HttpHeaderConfig": {
                            "HttpHeaderName": "x-cf-token",
                            "Values": [
                                "a1e935d1-b68e-43c4-b1f6-1a8d7528bd8c"
                            ]
                        }
                    }
                ],
                "ListenerArn": {
                    "Ref": "AlbListener"
                },
                "Priority": 1
            }
        },
        "Distribution": {
            "Type": "AWS::CloudFront::Distribution",
            "Properties": {
                "DistributionConfig": {
                    "Aliases": [
                        "containers.tfs.services"
                    ],
                    "DefaultCacheBehavior": {
                        "ForwardedValues": {
                            "Cookies": {
                                "Forward": "all"
                            },
                            "Headers": [
                                "*"
                            ],
                            "QueryString": true
                        },
                        "TargetOriginId": "LoadBalancer-origin",
                        "ViewerProtocolPolicy": "redirect-to-https"
                    },
                    "Enabled": true,
                    "HttpVersion": "http2",
                    "IPV6Enabled": true,
                    "Origins": [
                        {
                            "CustomOriginConfig": {
                                "OriginProtocolPolicy": "https-only"
                            },
                            "DomainName": {
                                "Fn::Join": [
                                    "",
                                    [
                                        "lb-",
                                        {
                                            "Ref": "rootStackName"
                                        },
                                        ".tfs.services"
                                    ]
                                ]
                            },
                            "Id": "LoadBalancer-origin",
                            "OriginCustomHeaders": [
                                {
                                    "HeaderName": "x-cf-token",
                                    "HeaderValue": "a1e935d1-b68e-43c4-b1f6-1a8d7528bd8c"
                                }
                            ]
                        }
                    ],
                    "ViewerCertificate": {
                        "AcmCertificateArn": {
                            "Ref": "Certificate"
                        },
                        "MinimumProtocolVersion": "TLSv1.2_2019",
                        "SslSupportMethod": "sni-only"
                    }
                }
            }
        },
        "RecordSetGroup": {
            "Type": "AWS::Route53::RecordSetGroup",
            "Properties": {
                "HostedZoneId": "Z07716653GDXJUDL4P879",
                "RecordSets": [
                    {
                        "AliasTarget": {
                            "DNSName": {
                                "Fn::GetAtt": [
                                    "LoadBalancer",
                                    "DNSName"
                                ]
                            },
                            "HostedZoneId": {
                                "Fn::GetAtt": [
                                    "LoadBalancer",
                                    "CanonicalHostedZoneID"
                                ]
                            }
                        },
                        "Name": {
                            "Fn::Join": [
                                "",
                                [
                                    "lb-",
                                    {
                                        "Ref": "rootStackName"
                                    },
                                    ".tfs.services"
                                ]
                            ]
                        },
                        "Type": "A"
                    },
                    {
                        "AliasTarget": {
                            "DNSName": {
                                "Fn::GetAtt": [
                                    "Distribution",
                                    "DomainName"
                                ]
                            },
                            "HostedZoneId": "Z2FDTNDATAQYW2"
                        },
                        "Name": "containers.tfs.services",
                        "Type": "A"
                    }
                ]
            }
        }
    },
    "Outputs": {
        "ServiceName": {
            "Value": "site-service-api-8080"
        },
        "ClusterName": {
            "Value": {
                "Ref": "NetworkStackClusterName"
            }
        },
        "PipelineName": {
            "Value": {
                "Fn::Join": [
                    "",
                    [
                        {
                            "Ref": "rootStackName"
                        },
                        "-site-service-api-8080"
                    ]
                ]
            }
        },
        "ContainerNames": {
            "Value": "api"
        },
        "PipelineUrl": {
            "Value": {
                "Fn::Join": [
                    "",
                    [
                        "https://",
                        {
                            "Ref": "AWS::Region"
                        },
                        ".console.aws.amazon.com/codesuite/codepipeline/pipelines/",
                        {
                            "Ref": "rootStackName"
                        },
                        "-site-service-api-8080/view"
                    ]
                ]
            }
        },
        "LoadBalancerAliasDomainName": {
            "Value": {
                "Fn::GetAtt": [
                    "LoadBalancer",
                    "DNSName"
                ]
            }
        },
        "LoadBalancerCnameDomainName": {
            "Value": {
                "Fn::Join": [
                    "",
                    [
                        "lb-",
                        {
                            "Ref": "rootStackName"
                        },
                        ".tfs.services"
                    ]
                ]
            }
        },
        "CloudfrontDistributionAliasDomainName": {
            "Value": {
                "Fn::GetAtt": [
                    "Distribution",
                    "DomainName"
                ]
            }
        },
        "CloudfrontDistributionCnameDomainName": {
            "Value": "containers.tfs.services"
        }
    }
}